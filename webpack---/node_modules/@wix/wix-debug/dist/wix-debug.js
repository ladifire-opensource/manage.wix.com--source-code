"use strict";

function _typeof(obj) { "@babel/helpers - typeof"; if (typeof Symbol === "function" && typeof Symbol.iterator === "symbol") { _typeof = function _typeof(obj) { return typeof obj; }; } else { _typeof = function _typeof(obj) { return obj && typeof Symbol === "function" && obj.constructor === Symbol && obj !== Symbol.prototype ? "symbol" : typeof obj; }; } return _typeof(obj); }

function ownKeys(object, enumerableOnly) { var keys = Object.keys(object); if (Object.getOwnPropertySymbols) { var symbols = Object.getOwnPropertySymbols(object); if (enumerableOnly) { symbols = symbols.filter(function (sym) { return Object.getOwnPropertyDescriptor(object, sym).enumerable; }); } keys.push.apply(keys, symbols); } return keys; }

function _objectSpread(target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i] != null ? arguments[i] : {}; if (i % 2) { ownKeys(Object(source), true).forEach(function (key) { _defineProperty(target, key, source[key]); }); } else if (Object.getOwnPropertyDescriptors) { Object.defineProperties(target, Object.getOwnPropertyDescriptors(source)); } else { ownKeys(Object(source)).forEach(function (key) { Object.defineProperty(target, key, Object.getOwnPropertyDescriptor(source, key)); }); } } return target; }

function _defineProperty(obj, key, value) { if (key in obj) { Object.defineProperty(obj, key, { value: value, enumerable: true, configurable: true, writable: true }); } else { obj[key] = value; } return obj; }

function _classCallCheck(instance, Constructor) { if (!(instance instanceof Constructor)) { throw new TypeError("Cannot call a class as a function"); } }

function _defineProperties(target, props) { for (var i = 0; i < props.length; i++) { var descriptor = props[i]; descriptor.enumerable = descriptor.enumerable || false; descriptor.configurable = true; if ("value" in descriptor) descriptor.writable = true; Object.defineProperty(target, descriptor.key, descriptor); } }

function _createClass(Constructor, protoProps, staticProps) { if (protoProps) _defineProperties(Constructor.prototype, protoProps); if (staticProps) _defineProperties(Constructor, staticProps); return Constructor; }

var debug = require('@wix/debug-no-namespace');

var resolve = require('./name-resolver');

var enableNamespace = require('./enable-namespace');

var assert = require('assert');

var jsonStringifySafe = require('json-stringify-safe'); // emit deprecation warning if used on server side


try {
  if (process && process.emitWarning && process.env && process.env.APP_CONF_DIR) {
    process.emitWarning('@wix/wix-debug is deprecated in server bootstrap projects. use @wix/wix-log instead', 'DeprecationWarning');
  }
} catch (err) {// ignore
}

var DebugLogger = /*#__PURE__*/function () {
  function DebugLogger(name) {
    var _this = this;

    var requestData = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : {};

    _classCallCheck(this, DebugLogger);

    assert(name, 'Name must be provided');
    this._requestData = requestData;
    this._name = name;
    var logKeys = resolve(name);
    this._namespace = logKeys['error'];
    debug.enable(enableNamespace(process.env['DEBUG'], this._namespace));
    ['info', 'debug', 'error', 'trace', 'warn'].forEach(function (level) {
      var levelNamespace = logKeys[level];
      _this["_".concat(level)] = logWith(cachedLogger(levelNamespace), _this._requestData, levelNamespace, level);
    });
  }

  _createClass(DebugLogger, [{
    key: "withRequest",
    value: function withRequest(req) {
      return this.withAspects(req.aspects);
    }
  }, {
    key: "withAspects",
    value: function withAspects(aspects) {
      var requestId = get(aspects, 'raw.inbound.x-wix-request-id');
      return new DebugLogger(this._name, _objectSpread(_objectSpread({}, requestId ? {
        requestId: requestId
      } : {
        requestId: undefined
      }), this._requestData));
    }
  }, {
    key: "trace",
    value: function trace() {
      for (var _len = arguments.length, args = new Array(_len), _key = 0; _key < _len; _key++) {
        args[_key] = arguments[_key];
      }

      this._trace(args);
    }
  }, {
    key: "debug",
    value: function debug() {
      for (var _len2 = arguments.length, args = new Array(_len2), _key2 = 0; _key2 < _len2; _key2++) {
        args[_key2] = arguments[_key2];
      }

      this._debug(args);
    }
  }, {
    key: "info",
    value: function info() {
      for (var _len3 = arguments.length, args = new Array(_len3), _key3 = 0; _key3 < _len3; _key3++) {
        args[_key3] = arguments[_key3];
      }

      this._info(args);
    }
  }, {
    key: "error",
    value: function error() {
      for (var _len4 = arguments.length, args = new Array(_len4), _key4 = 0; _key4 < _len4; _key4++) {
        args[_key4] = arguments[_key4];
      }

      this._error(args);
    }
  }, {
    key: "warn",
    value: function warn() {
      for (var _len5 = arguments.length, args = new Array(_len5), _key5 = 0; _key5 < _len5; _key5++) {
        args[_key5] = arguments[_key5];
      }

      this._warn(args);
    }
  }]);

  return DebugLogger;
}();

function toKeyValueStringPairs(requestData) {
  return Object.keys(requestData).map(function (key) {
    return "[".concat(key, ": ").concat(requestData[key], "]");
  });
}

function isJsonEnabled() {
  return process.env['JSON_STDOUT'] === 'enabled';
}

var LOGGERS = new Map();

function cachedLogger(key) {
  var logger = LOGGERS.get(key);

  if (!logger) {
    logger = debug(key);
    LOGGERS.set(key, logger);
  }

  return logger;
}

function logWith(logger, requestData, namespace, level) {
  if (isJsonEnabled()) {
    return function (argsArray) {
      if (argsArray.length > 1) {
        argsArray = argsArray.map(function (arg) {
          return arg instanceof Error ? errorToObject(arg) : arg;
        });

        if (argsArray.every(function (item) {
          return _typeof(item) !== 'object';
        })) {
          argsArray = [argsArray.join(',')];
        } else {
          argsArray = [jsonStringifySafe(argsArray)];
        }
      }

      return logger.apply(logger, argsArray.map(function (el) {
        return debug.coerce(toJson(el, namespace, requestData, level));
      }));
    };
  }

  return function (argsArray) {
    return logger.apply(logger, toKeyValueStringPairs(requestData).concat(argsArray).map(function (el) {
      return debug.coerce(el);
    }));
  };
}

function toJson(param, namespace, requestData, level) {
  var _appName = process.env['APP_NAME'] || 'APP_NAME_NOT_SET';

  var _hostName = process.env['HOSTNAME'] || 'HOSTNAME_NOT_SET';

  var _dc = process.env['DC_NAME'] || 'DC_NOT_SET';

  var _shortAppName = process.env['SHORT_APP_NAME'] || 'SHORT_APP_NAME_NOT_SET';

  var additionalParams = {
    _appName: _appName,
    _hostName: _hostName,
    _dc: _dc,
    _shortAppName: _shortAppName,
    _namespace: namespace,
    _requestData: toKeyValueStringPairs(requestData),
    wnp_requestId: requestData.requestId,
    request_id: requestData.requestId,
    wnp_namespace: namespace,
    timestamp: new Date().toISOString(),
    level: level.toUpperCase()
  };

  if (param instanceof Object) {
    if (Array.isArray(param)) {
      return jsonStringifySafe(_objectSpread(_objectSpread({}, additionalParams), {}, {
        text: jsonStringifySafe(param)
      }));
    }

    if (param instanceof Error) {
      return jsonStringifySafe(_objectSpread(_objectSpread({}, additionalParams), errorToObject(param)));
    }

    if (param._appName || param._hostName || param._dc || param._shortAppName || param._namespace || param._requestData || param.timestamp || Object.keys(param).find(function (k) {
      return k.startsWith('wnp_');
    })) {
      return jsonStringifySafe(_objectSpread(_objectSpread({}, additionalParams), {}, {
        data: param,
        error: {
          message: 'Please don\'t use \'_appName\', \'_hostName\', \'_dc\', \'_shortAppName\', \'_namespace\', \'_requestData\', \'timestamp\' and params starting with \'wnp_\' in your JSON payload!'
        }
      }));
    }

    return jsonStringifySafe(_objectSpread(_objectSpread({}, additionalParams), param));
  }

  return jsonStringifySafe(_objectSpread(_objectSpread({}, additionalParams), {}, {
    text: param
  }));
}

function errorToObject(err) {
  return {
    errorData: {
      message: err.message,
      name: err.name,
      stack: err.stack
    },
    message: err.message
  };
}

function get(obj, path) {
  var parts = path.split('.');
  var result = obj;

  while (result !== undefined && parts.length > 0) {
    result = result[parts.shift()];
  }

  return result;
}

module.exports = function (name) {
  return new DebugLogger(name);
};

module.exports.Logger = DebugLogger;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy93aXgtZGVidWcuanMiXSwibmFtZXMiOlsiZGVidWciLCJyZXF1aXJlIiwicmVzb2x2ZSIsImVuYWJsZU5hbWVzcGFjZSIsImFzc2VydCIsImpzb25TdHJpbmdpZnlTYWZlIiwicHJvY2VzcyIsImVtaXRXYXJuaW5nIiwiZW52IiwiQVBQX0NPTkZfRElSIiwiZXJyIiwiRGVidWdMb2dnZXIiLCJuYW1lIiwicmVxdWVzdERhdGEiLCJfcmVxdWVzdERhdGEiLCJfbmFtZSIsImxvZ0tleXMiLCJfbmFtZXNwYWNlIiwiZW5hYmxlIiwiZm9yRWFjaCIsImxldmVsIiwibGV2ZWxOYW1lc3BhY2UiLCJsb2dXaXRoIiwiY2FjaGVkTG9nZ2VyIiwicmVxIiwid2l0aEFzcGVjdHMiLCJhc3BlY3RzIiwicmVxdWVzdElkIiwiZ2V0IiwidW5kZWZpbmVkIiwiYXJncyIsIl90cmFjZSIsIl9kZWJ1ZyIsIl9pbmZvIiwiX2Vycm9yIiwiX3dhcm4iLCJ0b0tleVZhbHVlU3RyaW5nUGFpcnMiLCJPYmplY3QiLCJrZXlzIiwibWFwIiwia2V5IiwiaXNKc29uRW5hYmxlZCIsIkxPR0dFUlMiLCJNYXAiLCJsb2dnZXIiLCJzZXQiLCJuYW1lc3BhY2UiLCJhcmdzQXJyYXkiLCJsZW5ndGgiLCJhcmciLCJFcnJvciIsImVycm9yVG9PYmplY3QiLCJldmVyeSIsIml0ZW0iLCJqb2luIiwiYXBwbHkiLCJlbCIsImNvZXJjZSIsInRvSnNvbiIsImNvbmNhdCIsInBhcmFtIiwiX2FwcE5hbWUiLCJfaG9zdE5hbWUiLCJfZGMiLCJfc2hvcnRBcHBOYW1lIiwiYWRkaXRpb25hbFBhcmFtcyIsInducF9yZXF1ZXN0SWQiLCJyZXF1ZXN0X2lkIiwid25wX25hbWVzcGFjZSIsInRpbWVzdGFtcCIsIkRhdGUiLCJ0b0lTT1N0cmluZyIsInRvVXBwZXJDYXNlIiwiQXJyYXkiLCJpc0FycmF5IiwidGV4dCIsImZpbmQiLCJrIiwic3RhcnRzV2l0aCIsImRhdGEiLCJlcnJvciIsIm1lc3NhZ2UiLCJlcnJvckRhdGEiLCJzdGFjayIsIm9iaiIsInBhdGgiLCJwYXJ0cyIsInNwbGl0IiwicmVzdWx0Iiwic2hpZnQiLCJtb2R1bGUiLCJleHBvcnRzIiwiTG9nZ2VyIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7Ozs7O0FBQUEsSUFBTUEsS0FBSyxHQUFHQyxPQUFPLENBQUMseUJBQUQsQ0FBckI7O0FBQ0EsSUFBTUMsT0FBTyxHQUFHRCxPQUFPLENBQUMsaUJBQUQsQ0FBdkI7O0FBQ0EsSUFBTUUsZUFBZSxHQUFHRixPQUFPLENBQUMsb0JBQUQsQ0FBL0I7O0FBQ0EsSUFBTUcsTUFBTSxHQUFHSCxPQUFPLENBQUMsUUFBRCxDQUF0Qjs7QUFDQSxJQUFNSSxpQkFBaUIsR0FBR0osT0FBTyxDQUFDLHFCQUFELENBQWpDLEMsQ0FFQTs7O0FBQ0EsSUFBSTtBQUNGLE1BQUlLLE9BQU8sSUFBSUEsT0FBTyxDQUFDQyxXQUFuQixJQUFrQ0QsT0FBTyxDQUFDRSxHQUExQyxJQUFpREYsT0FBTyxDQUFDRSxHQUFSLENBQVlDLFlBQWpFLEVBQStFO0FBQzdFSCxJQUFBQSxPQUFPLENBQUNDLFdBQVIsQ0FBb0IscUZBQXBCLEVBQTJHLG9CQUEzRztBQUNEO0FBQ0YsQ0FKRCxDQUlFLE9BQU9HLEdBQVAsRUFBWSxDQUNaO0FBQ0Q7O0lBRUtDLFc7QUFDSix1QkFBWUMsSUFBWixFQUFvQztBQUFBOztBQUFBLFFBQWxCQyxXQUFrQix1RUFBSixFQUFJOztBQUFBOztBQUNsQ1QsSUFBQUEsTUFBTSxDQUFDUSxJQUFELEVBQU8sdUJBQVAsQ0FBTjtBQUNBLFNBQUtFLFlBQUwsR0FBb0JELFdBQXBCO0FBQ0EsU0FBS0UsS0FBTCxHQUFhSCxJQUFiO0FBQ0EsUUFBTUksT0FBTyxHQUFHZCxPQUFPLENBQUNVLElBQUQsQ0FBdkI7QUFDQSxTQUFLSyxVQUFMLEdBQWtCRCxPQUFPLENBQUMsT0FBRCxDQUF6QjtBQUVBaEIsSUFBQUEsS0FBSyxDQUFDa0IsTUFBTixDQUFhZixlQUFlLENBQUNHLE9BQU8sQ0FBQ0UsR0FB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TUxGLElBQUFBLE9BQU8sRUFBRXZFLEdBQUcsQ0FBQ3VFO0FBTlIsR0FBUDtBQVFEOztBQUVELFNBQVNyRCxHQUFULENBQWF3RCxHQUFiLEVBQWtCQyxJQUFsQixFQUF3QjtBQUN0QixNQUFNQyxLQUFLLEdBQUdELElBQUksQ0FBQ0UsS0FBTCxDQUFXLEdBQVgsQ0FBZDtBQUNBLE1BQUlDLE1BQU0sR0FBR0osR0FBYjs7QUFDQSxTQUFPSSxNQUFNLEtBQUszRCxTQUFYLElBQXdCeUQsS0FBSyxDQUFDdEMsTUFBTixHQUFlLENBQTlDLEVBQWlEO0FBQy9Dd0MsSUFBQUEsTUFBTSxHQUFHQSxNQUFNLENBQUNGLEtBQUssQ0FBQ0csS0FBTixFQUFELENBQWY7QUFDRDs7QUFDRCxTQUFPRCxNQUFQO0FBQ0Q7O0FBR0RFLE1BQU0sQ0FBQ0MsT0FBUCxHQUFpQixVQUFBL0UsSUFBSTtBQUFBLFNBQUksSUFBSUQsV0FBSixDQUFnQkMsSUFBaEIsQ0FBSjtBQUFBLENBQXJCOztBQUNBOEUsTUFBTSxDQUFDQyxPQUFQLENBQWVDLE1BQWYsR0FBd0JqRixXQUF4QiIsInNvdXJjZXNDb250ZW50IjpbImNvbnN0IGRlYnVnID0gcmVxdWlyZSgnQHdpeC9kZWJ1Zy1uby1uYW1lc3BhY2UnKTtcbmNvbnN0IHJlc29sdmUgPSByZXF1aXJlKCcuL25hbWUtcmVzb2x2ZXInKTtcbmNvbnN0IGVuYWJsZU5hbWVzcGFjZSA9IHJlcXVpcmUoJy4vZW5hYmxlLW5hbWVzcGFjZScpO1xuY29uc3QgYXNzZXJ0ID0gcmVxdWlyZSgnYXNzZXJ0Jyk7XG5jb25zdCBqc29uU3RyaW5naWZ5U2FmZSA9IHJlcXVpcmUoJ2pzb24tc3RyaW5naWZ5LXNhZmUnKTtcblxuLy8gZW1pdCBkZXByZWNhdGlvbiB3YXJuaW5nIGlmIHVzZWQgb24gc2VydmVyIHNpZGVcbnRyeSB7XG4gIGlmIChwcm9jZXNzICYmIHByb2Nlc3MuZW1pdFdhcm5pbmcgJiYgcHJvY2Vzcy5lbnYgJiYgcHJvY2Vzcy5lbnYuQVBQX0NPTkZfRElSKSB7XG4gICAgcHJvY2Vzcy5lbWl0V2FybmluZygnQHdpeC93aXgtZGVidWcgaXMgZGVwcmVjYXRlZCBpbiBzZXJ2ZXIgYm9vdHN0cmFwIHByb2plY3RzLiB1c2UgQHdpeC93aXgtbG9nIGluc3RlYWQnLCAnRGVwcmVjYXRpb25XYXJuaW5nJyk7XG4gIH1cbn0gY2F0Y2ggKGVycikge1xuICAvLyBpZ25vcmVcbn1cblxuY2xhc3MgRGVidWdMb2dnZXIge1xuICBjb25zdHJ1Y3RvcihuYW1lLCByZXF1ZXN0RGF0YSA9IHt9KSB7XG4gICAgYXNzZXJ0KG5hbWUsICdOYW1lIG11c3QgYmUgcHJvdmlkZWQnKTtcbiAgICB0aGlzLl9yZXF1ZXN0RGF0YSA9IHJlcXVlc3REYXRhO1xuICAgIHRoaXMuX25hbWUgPSBuYW1lO1xuICAgIGNvbnN0IGxvZ0tleXMgPSByZXNvbHZlKG5hbWUpO1xuICAgIHRoaXMuX25hbWVzcGFjZSA9IGxvZ0tleXNbJ2Vycm9yJ107XG5cbiAgICBkZWJ1Zy5lbmFibGUoZW5hYmxlTmFtZXNwYWNlKHByb2Nlc3MuZW52WydERUJVRyddLCB0aGlzLl9uYW1lc3BhY2UpKTtcblxuICAgIFsnaW5mbycsICdkZWJ1ZycsICdlcnJvcicsICd0cmFjZScsICd3YXJuJ10uZm9yRWFjaChsZXZlbCA9PiB7XG4gICAgICBjb25zdCBsZXZlbE5hbWVzcGFjZSA9IGxvZ0tleXNbbGV2ZWxdO1xuICAgICAgdGhpc1tgXyR7bGV2ZWx9YF0gPSBsb2dXaXRoKGNhY2hlZExvZ2dlcihsZXZlbE5hbWVzcGFjZSksIHRoaXMuX3JlcXVlc3REYXRhLCBsZXZlbE5hbWVzcGFjZSwgbGV2ZWwpO1xuICAgIH0pO1xuICB9XG5cbiAgd2l0aFJlcXVlc3QocmVxKSB7XG4gICAgcmV0dXJuIHRoaXMud2l0aEFzcGVjdHMocmVxLmFzcGVjdHMpO1xuICB9XG5cbiAgd2l0aEFzcGVjdHMoYXNwZWN0cykge1xuICAgIGNvbnN0IHJlcXVlc3RJZCA9IGdldChhc3BlY3RzLCAncmF3LmluYm91bmQueC13aXgtcmVxdWVzdC1pZCcpO1xuICAgIHJldHVybiBuZXcgRGVidWdMb2dnZXIodGhpcy5fbmFtZSwge1xuICAgICAgLi4uKHJlcXVlc3RJZCA/IHtyZXF1ZXN0SWR9IDoge3JlcXVlc3RJZDogdW5kZWZpbmVkfSksXG4gICAgICAuLi50aGlzLl9yZXF1ZXN0RGF0YVxuICAgIH0pO1xuICB9XG5cbiAgdHJhY2UoLi4uYXJncykge1xuICAgIHRoaXMuX3RyYWNlKGFyZ3MpO1xuICB9XG5cbiAgZGVidWcoLi4uYXJncykge1xuICAgIHRoaXMuX2RlYnVnKGFyZ3MpO1xuICB9XG5cbiAgaW5mbyguLi5hcmdzKSB7XG4gICAgdGhpcy5faW5mbyhhcmdzKTtcbiAgfVxuXG4gIGVycm9yKC4uLmFyZ3MpIHtcbiAgICB0aGlzLl9lcnJvcihhcmdzKTtcbiAgfVxuXG4gIHdhcm4oLi4uYXJncykge1xuICAgIHRoaXMuX3dhcm4oYXJncyk7XG4gIH1cbn1cblxuZnVuY3Rpb24gdG9LZXlWYWx1ZVN0cmluZ1BhaXJzKHJlcXVlc3REYXRhKSB7XG4gIHJldHVybiBPYmplY3Qua2V5cyhyZXF1ZXN0RGF0YSkubWFwKGtleSA9PiBgWyR7a2V5fTogJHtyZXF1ZXN0RGF0YVtrZXldfV1gKTtcbn1cblxuZnVuY3Rpb24gaXNKc29uRW5hYmxlZCgpIHtcbiAgcmV0dXJuIHByb2Nlc3MuZW52WydKU09OX1NURE9VVCddID09PSAnZW5hYmxlZCc7XG59XG5cbmNvbnN0IExPR0dFUlMgPSBuZXcgTWFwKCk7XG5mdW5jdGlvbiBjYWNoZWRMb2dnZXIoa2V5KSB7XG4gIGxldCBsb2dnZXIgPSBMT0dHRVJTLmdldChrZXkpO1xuICBpZiAoIWxvZ2dlcikge1xuICAgIGxvZ2dlciA9IGRlYnVnKGtleSk7XG4gICAgTE9HR0VSUy5zZXQoa2V5LCBsb2dnZXIpO1xuICB9XG4gIHJldHVybiBsb2dnZXI7XG59XG5cbmZ1bmN0aW9uIGxvZ1dpdGgobG9nZ2VyLCByZXF1ZXN0RGF0YSwgbmFtZXNwYWNlLCBsZXZlbCkge1xuICBpZiAoaXNKc29uRW5hYmxlZCgpKSB7XG4gICAgcmV0dXJuIGFyZ3NBcnJheSA9PiB7XG4gICAgICBpZiAoYXJnc0FycmF5Lmxlbmd0aCA+IDEpIHtcbiAgICAgICAgYXJnc0FycmF5ID0gYXJnc0FycmF5Lm1hcChhcmcgPT4gYXJnIGluc3RhbmNlb2YgRXJyb3IgPyBlcnJvclRvT2JqZWN0KGFyZykgOiBhcmcpO1xuICAgICAgICBpZiAoYXJnc0FycmF5LmV2ZXJ5KGl0ZW0gPT4gdHlwZW9mIGl0ZW0gIT09ICdvYmplY3QnKSkge1xuICAgICAgICAgIGFyZ3NBcnJheSA9IFthcmdzQXJyYXkuam9pbignLCcpXTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICBhcmdzQXJyYXkgPSBbanNvblN0cmluZ2lmeVNhZmUoYXJnc0FycmF5KV07XG4gICAgICAgIH1cbiAgICAgIH1cblxuICAgICAgcmV0dXJuIGxvZ2dlci5hcHBseShsb2dnZXIsIGFyZ3NBcnJheS5tYXAoZWwgPT4ge1xuICAgICAgICByZXR1cm4gZGVidWcuY29lcmNlKHRvSnNvbihlbCwgbmFtZXNwYWNlLCByZXF1ZXN0RGF0YSwgbGV2ZWwpKTtcbiAgICAgIH0pKTtcbiAgICB9O1xuICB9XG5cbiAgcmV0dXJuIGFyZ3NBcnJheSA9PiBsb2dnZXIuYXBwbHkobG9nZ2VyLCB0b0tleVZhbHVlU3RyaW5nUGFpcnMocmVxdWVzdERhdGEpLmNvbmNhdChhcmdzQXJyYXkpLm1hcChlbCA9PiB7XG4gICAgcmV0dXJuIGRlYnVnLmNvZXJjZShlbCk7XG4gIH0pKTtcbn1cblxuZnVuY3Rpb24gdG9Kc29uKHBhcmFtLCBuYW1lc3BhY2UsIHJlcXVlc3REYXRhLCBsZXZlbCkge1xuICBjb25zdCBfYXBwTmFtZSA9IHByb2Nlc3MuZW52WydBUFBfTkFNRSddIHx8ICdBUFBfTkFNRV9OT1RfU0VUJztcbiAgY29uc3QgX2hvc3ROYW1lID0gcHJvY2Vzcy5lbnZbJ0hPU1ROQU1FJ10gfHwgJ0hPU1ROQU1FX05PVF9TRVQnO1xuICBjb25zdCBfZGMgPSBwcm9jZXNzLmVudlsnRENfTkFNRSddIHx8ICdEQ19OT1RfU0VUJztcbiAgY29uc3QgX3Nob3J0QXBwTmFtZSA9IHByb2Nlc3MuZW52WydTSE9SVF9BUFBfTkFNRSddIHx8ICdTSE9SVF9BUFBfTkFNRV9OT1RfU0VUJztcblxuICBjb25zdCBhZGRpdGlvbmFsUGFyYW1zID0ge1xuICAgIF9hcHBOYW1lLFxuICAgIF9ob3N0TmFtZSxcbiAgICBfZGMsXG4gICAgX3Nob3J0QXBwTmFtZSxcbiAgICBfbmFtZXNwYWNlOiBuYW1lc3BhY2UsXG4gICAgX3JlcXVlc3REYXRhOiB0b0tleVZhbHVlU3RyaW5nUGFpcnMocmVxdWVzdERhdGEpLFxuICAgIHducF9yZXF1ZXN0SWQ6IHJlcXVlc3REYXRhLnJlcXVlc3RJZCxcbiAgICByZXF1ZXN0X2lkOiByZXF1ZXN0RGF0YS5yZXF1ZXN0SWQsXG4gICAgd25wX25hbWVzcGFjZTogbmFtZXNwYWNlLFxuICAgIHRpbWVzdGFtcDogbmV3IERhdGUoKS50b0lTT1N0cmluZygpLFxuICAgIGxldmVsOiBsZXZlbC50b1VwcGVyQ2FzZSgpXG4gIH07XG5cbiAgaWYgKHBhcmFtIGluc3RhbmNlb2YgT2JqZWN0KSB7XG4gICAgaWYgKEFycmF5LmlzQXJyYXkocGFyYW0pKSB7XG4gICAgICByZXR1cm4ganNvblN0cmluZ2lmeVNhZmUoe1xuICAgICAgICAuLi5hZGRpdGlvbmFsUGFyYW1zLFxuICAgICAgICB0ZXh0OiBqc29uU3RyaW5naWZ5U2FmZShwYXJhbSlcbiAgICAgIH0pO1xuICAgIH1cblxuICAgIGlmIChwYXJhbSBpbnN0YW5jZW9mIEVycm9yKSB7XG4gICAgICByZXR1cm4ganNvblN0cmluZ2lmeVNhZmUoe1xuICAgICAgICAuLi5hZGRpdGlvbmFsUGFyYW1zLFxuICAgICAgICAuLi5lcnJvclRvT2JqZWN0KHBhcmFtKVxuICAgICAgfSk7XG4gICAgfVxuXG4gICAgaWYgKHBhcmFtLl9hcHBOYW1lIHx8IHBhcmFtLl9ob3N0TmFtZSB8fCBwYXJhbS5fZGMgfHwgcGFyYW0uX3Nob3J0QXBwTmFtZSB8fCBwYXJhbS5fbmFtZXNwYWNlIHx8IHBhcmFtLl9yZXF1ZXN0RGF0YSB8fCBwYXJhbS50aW1lc3RhbXAgfHwgT2JqZWN0LmtleXMocGFyYW0pLmZpbmQoayA9PiBrLnN0YXJ0c1dpdGgoJ3ducF8nKSkpIHtcbiAgICAgIHJldHVybiBqc29uU3RyaW5naWZ5U2FmZSh7XG4gICAgICAgIC4uLmFkZGl0aW9uYWxQYXJhbXMsXG4gICAgICAgIGRhdGE6IHBhcmFtLFxuICAgICAgICBlcnJvcjoge1xuICAgICAgICAgIG1lc3NhZ2U6ICdQbGVhc2UgZG9uXFwndCB1c2UgXFwnX2FwcE5hbWVcXCcsIFxcJ19ob3N0TmFtZVxcJywgXFwnX2RjXFwnLCBcXCdfc2hvcnRBcHBOYW1lXFwnLCBcXCdfbmFtZXNwYWNlXFwnLCBcXCdfcmVxdWVzdERhdGFcXCcsIFxcJ3RpbWVzdGFtcFxcJyBhbmQgcGFyYW1zIHN0YXJ0aW5nIHdpdGggXFwnd25wX1xcJyBpbiB5b3VyIEpTT04gcGF5bG9hZCEnXG4gICAgICAgIH1cbiAgICAgIH0pO1xuICAgIH1cblxuICAgIHJldHVybiBqc29uU3RyaW5naWZ5U2FmZSh7XG4gICAgICAuLi5hZGRpdGlvbmFsUGFyYW1zLFxuICAgICAgLi4ucGFyYW1cbiAgICB9KTtcbiAgfVxuXG4gIHJldHVybiBqc29uU3RyaW5naWZ5U2FmZSh7XG4gICAgLi4uYWRkaXRpb25hbFBhcmFtcyxcbiAgICB0ZXh0OiBwYXJhbVxuICB9KTtcbn1cblxuZnVuY3Rpb24gZXJyb3JUb09iamVjdChlcnIpIHtcbiAgcmV0dXJuIHtcbiAgICBlcnJvckRhdGE6IHtcbiAgICAgIG1lc3NhZ2U6IGVyci5tZXNzYWdlLFxuICAgICAgbmFtZTogZXJyLm5hbWUsXG4gICAgICBzdGFjazogZXJyLnN0YWNrXG4gICAgfSxcbiAgICBtZXNzYWdlOiBlcnIubWVzc2FnZVxuICB9O1xufVxuXG5mdW5jdGlvbiBnZXQob2JqLCBwYXRoKSB7XG4gIGNvbnN0IHBhcnRzID0gcGF0aC5zcGxpdCgnLicpO1xuICBsZXQgcmVzdWx0ID0gb2JqO1xuICB3aGlsZSAocmVzdWx0ICE9PSB1bmRlZmluZWQgJiYgcGFydHMubGVuZ3RoID4gMCkge1xuICAgIHJlc3VsdCA9IHJlc3VsdFtwYXJ0cy5zaGlmdCgpXTtcbiAgfVxuICByZXR1cm4gcmVzdWx0O1xufVxuXG5cbm1vZHVsZS5leHBvcnRzID0gbmFtZSA9PiBuZXcgRGVidWdMb2dnZXIobmFtZSk7XG5tb2R1bGUuZXhwb3J0cy5Mb2dnZXIgPSBEZWJ1Z0xvZ2dlcjtcbiJdfQ==